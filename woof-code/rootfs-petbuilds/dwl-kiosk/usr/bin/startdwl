#!/bin/sh

export TEXTDOMAIN=xwin
export OUTPUT_CHARSET=UTF-8

export WLR_RENDERER_ALLOW_SOFTWARE=1

export PULSE_SERVER=unix:/tmp/runtime-spot/pulse/native
export PULSE_COOKIE=/home/spot/.config/pulse/cookie

while :
do
	unset XKB_DEFAULT_LAYOUT
	unset XKB_DEFAULT_MODEL
	unset XKB_DEFAULT_OPTIONS
	unset XKB_DEFAULT_RULES
	unset XKB_DEFAULT_VARIANT
	unset LIBINPUT_DEFAULT_TAP
	unset LIBINPUT_DEFAULT_NATURAL_SCROLL
	unset LIBINPUT_DEFAULT_ACCELERATION
	unset LIBINPUT_DEFAULT_ACCELERATION_PROFILE
	unset LIBINPUT_DEFAULT_SCROLL_METHOD
	unset LIBINPUT_DEFAULT_CLICK_METHOD
	unset LIBINPUT_DEFAULT_DRAG
	unset LIBINPUT_DEFAULT_DISABLE_WHILE_TYPING
	unset LIBINPUT_DEFAULT_MIDDLE_EMULATION
	unset LIBINPUT_DEFAULT_LEFT_HANDED
	unset GDK_BACKEND
	unset MOZ_ENABLE_WAYLAND

	. ~/.xkbrc
	[ -n "$XKB_DEFAULT_LAYOUT" ] && export XKB_DEFAULT_LAYOUT
	[ -n "$XKB_DEFAULT_MODEL" ] && export XKB_DEFAULT_MODEL
	[ -n "$XKB_DEFAULT_OPTIONS" ] && export XKB_DEFAULT_OPTIONS
	[ -n "$XKB_DEFAULT_RULES" ] && export XKB_DEFAULT_RULES
	[ -n "$XKB_DEFAULT_VARIANT" ] && export XKB_DEFAULT_VARIANT
	. ~/.inputrc
	[ -n "$LIBINPUT_DEFAULT_TAP" ] && export LIBINPUT_DEFAULT_TAP
	[ -n "$LIBINPUT_DEFAULT_NATURAL_SCROLL" ] && export LIBINPUT_DEFAULT_NATURAL_SCROLL
	[ -n "$LIBINPUT_DEFAULT_ACCELERATION" ] && export LIBINPUT_DEFAULT_ACCELERATION
	[ -n "$LIBINPUT_DEFAULT_ACCELERATION_PROFILE" ] && export LIBINPUT_DEFAULT_ACCELERATION_PROFILE
	[ -n "$LIBINPUT_DEFAULT_SCROLL_METHOD" ] && export LIBINPUT_DEFAULT_SCROLL_METHOD
	[ -n "$LIBINPUT_DEFAULT_CLICK_METHOD" ] && export LIBINPUT_DEFAULT_CLICK_METHOD
	[ -n "$LIBINPUT_DEFAULT_DRAG" ] && export LIBINPUT_DEFAULT_DRAG
	[ -n "$LIBINPUT_DEFAULT_DISABLE_WHILE_TYPING" ] && export LIBINPUT_DEFAULT_DISABLE_WHILE_TYPING
	[ -n "$LIBINPUT_DEFAULT_MIDDLE_EMULATION" ] && export LIBINPUT_DEFAULT_MIDDLE_EMULATION
	[ -n "$LIBINPUT_DEFAULT_LEFT_HANDED" ] && export LIBINPUT_DEFAULT_LEFT_HANDED
	. ~/.dwlrc
	[ -n "$GDK_BACKEND" ] && export GDK_BACKEND

	DWL_ARGS="-s ~/.dwlinitrc"
	if [ "$GDK_BACKEND" = "x11" ]; then
		DWL_ARGS="$DWL_ARGS -k"
	else
		export MOZ_ENABLE_WAYLAND=1
		DWL_ARGS="$DWL_ARGS -f"
	fi

	if [ -f /var/local/xwin_disable_xerrs_log_flag ]; then
		dbus-run-session -- dwl-kiosk $DWL_ARGS > /dev/null 2>&1
	else
		dbus-run-session -- dwl-kiosk $DWL_ARGS > /tmp/xerrs.log 2>&1
	fi

	. /tmp/.spot-session-bus
	kill $DBUS_SESSION_BUS_PID 2>/dev/null

	echo '--------'
	echo ''$(gettext 'Exited from dwl. Type "startdwl" to restart dwl.')''
	echo '-'
	echo ''$(gettext '(To shutdown PC type "poweroff", to reboot PC type "reboot")')''

	WMEXITMODE="`cat /tmp/wmexitmode.txt 2>/dev/null`"
	case "$WMEXITMODE" in
	poweroff|reboot)
		exec $WMEXITMODE
		;;

	exit)
		rm -f /tmp/wmexitmode.txt
		exit
		;;

	"")
		exit
		;;
	esac

	sleep 1
done